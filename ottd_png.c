#include "ottd.h"

png_color ottd_color[256] = {
/*   0 */ {0x00, 0x00, 0x00}, {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, 
/*   4 */ {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, 
/*   8 */ {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, {0xa8, 0xa8, 0xa8}, {0xb8, 0xb8, 0xb8}, 
/*  12 */ {0xc8, 0xc8, 0xc8}, {0xd8, 0xd8, 0xd8}, {0xe8, 0xe8, 0xe8}, {0xfc, 0xfc, 0xfc}, 
/*  16 */ {0x34, 0x3c, 0x48}, {0x44, 0x4c, 0x5c}, {0x58, 0x60, 0x70}, {0x6c, 0x74, 0x84}, 
/*  20 */ {0x84, 0x8c, 0x98}, {0x9c, 0xa0, 0xac}, {0xb0, 0xb8, 0xc4}, {0xcc, 0xd0, 0xdc}, 
/*  24 */ {0x30, 0x2c, 0x04}, {0x40, 0x3c, 0x0c}, {0x50, 0x4c, 0x14}, {0x60, 0x5c, 0x1c}, 
/*  28 */ {0x78, 0x78, 0x40}, {0x94, 0x94, 0x64}, {0xb0, 0xb0, 0x84}, {0xcc, 0xcc, 0xa8}, 
/*  32 */ {0x64, 0x64, 0x64}, {0x74, 0x74, 0x74}, {0x68, 0x50, 0x2c}, {0x7c, 0x68, 0x48}, 
/*  36 */ {0x98, 0x84, 0x5c}, {0xb8, 0xa0, 0x78}, {0xd4, 0xbc, 0x94}, {0xf4, 0xdc, 0xb0}, 
/*  40 */ {0x84, 0x84, 0x84}, {0x58, 0x04, 0x10}, {0x70, 0x10, 0x20}, {0x88, 0x20, 0x34}, 
/*  44 */ {0xa0, 0x38, 0x4c}, {0xbc, 0x54, 0x6c}, {0xcc, 0x68, 0x7c}, {0xdc, 0x84, 0x90}, 
/*  48 */ {0xec, 0x9c, 0xa4}, {0xfc, 0xbc, 0xc0}, {0xfc, 0xd4, 0x00}, {0xfc, 0xe8, 0x3c}, 
/*  52 */ {0xfc, 0xf8, 0x80}, {0x4c, 0x28, 0x00}, {0x60, 0x3c, 0x08}, {0x74, 0x58, 0x1c}, 
/*  56 */ {0x88, 0x74, 0x38}, {0x9c, 0x88, 0x50}, {0xb0, 0x9c, 0x6c}, {0xc4, 0xb4, 0x88}, 
/*  60 */ {0x44, 0x18, 0x00}, {0x60, 0x2c, 0x04}, {0x80, 0x44, 0x08}, {0x9c, 0x60, 0x10}, 
/*  64 */ {0xb8, 0x78, 0x18}, {0xd4, 0x9c, 0x20}, {0xe8, 0xb8, 0x10}, {0xfc, 0xd4, 0x00}, 
/*  68 */ {0xfc, 0xf8, 0x80}, {0xfc, 0xfc, 0xc0}, {0x20, 0x04, 0x00}, {0x40, 0x14, 0x08}, 
/*  72 */ {0x54, 0x1c, 0x10}, {0x6c, 0x2c, 0x1c}, {0x80, 0x38, 0x28}, {0x94, 0x48, 0x38}, 
/*  76 */ {0xa8, 0x5c, 0x4c}, {0xb8, 0x6c, 0x58}, {0xc4, 0x80, 0x6c}, {0xd4, 0x94, 0x80}, 
/*  80 */ {0x08, 0x34, 0x00}, {0x10, 0x40, 0x00}, {0x20, 0x50, 0x04}, {0x30, 0x60, 0x04}, 
/*  84 */ {0x40, 0x70, 0x0c}, {0x54, 0x84, 0x14}, {0x68, 0x94, 0x1c}, {0x80, 0xa8, 0x2c}, 
/*  88 */ {0x40, 0x40, 0x40}, {0x2c, 0x44, 0x20}, {0x3c, 0x58, 0x30}, {0x50, 0x68, 0x3c}, 
/*  92 */ {0x68, 0x7c, 0x4c}, {0x80, 0x94, 0x5c}, {0x98, 0xb0, 0x6c}, {0xb4, 0xcc, 0x7c}, 
/*  96 */ {0x10, 0x34, 0x18}, {0x20, 0x48, 0x2c}, {0x38, 0x60, 0x48}, {0x4c, 0x74, 0x58}, 
/* 100 */ {0x60, 0x88, 0x6c}, {0x78, 0xa4, 0x88}, {0x98, 0xc0, 0xa8}, {0xb8, 0xdc, 0xc8}, 
/* 104 */ {0x20, 0x18, 0x00}, {0x38, 0x1c, 0x00}, {0x50, 0x50, 0x50}, {0x58, 0x34, 0x0c}, 
/* 108 */ {0x68, 0x40, 0x18}, {0x7c, 0x54, 0x2c}, {0x8c, 0x6c, 0x40}, {0xa0, 0x80, 0x58}, 
/* 112 */ {0x4c, 0x28, 0x10}, {0x60, 0x34, 0x18}, {0x74, 0x44, 0x28}, {0x88, 0x54, 0x38}, 
/* 116 */ {0xa4, 0x60, 0x40}, {0xb8, 0x70, 0x50}, {0xcc, 0x80, 0x60}, {0xd4, 0x94, 0x70}, 
/* 120 */ {0xe0, 0xa8, 0x80}, {0xec, 0xbc, 0x94}, {0x50, 0x1c, 0x04}, {0x64, 0x28, 0x14}, 
/* 124 */ {0x78, 0x38, 0x28}, {0x8c, 0x4c, 0x40}, {0xa0, 0x64, 0x60}, {0xb8, 0x88, 0x88}, 
/* 128 */ {0x24, 0x28, 0x44}, {0x30, 0x34, 0x54}, {0x40, 0x40, 0x64}, {0x50, 0x50, 0x74}, 
/* 132 */ {0x64, 0x64, 0x88}, {0x84, 0x84, 0xa4}, {0xac, 0xac, 0xc0}, {0xd4, 0xd4, 0xe0}, 
/* 136 */ {0x30, 0x30, 0x30}, {0x40, 0x2c, 0x90}, {0x58, 0x40, 0xac}, {0x68, 0x4c, 0xc4}, 
/* 140 */ {0x78, 0x58, 0xe0}, {0x8c, 0x68, 0xfc}, {0xa0, 0x88, 0xfc}, {0xbc, 0xa8, 0xfc}, 
/* 144 */ {0x00, 0x18, 0x6c}, {0x00, 0x24, 0x84}, {0x00, 0x34, 0xa0}, {0x00, 0x48, 0xb8}, 
/* 148 */ {0x00, 0x60, 0xd4}, {0x18, 0x78, 0xdc}, {0x38, 0x90, 0xe8}, {0x58, 0xa8, 0xf0}, 
/* 152 */ {0x80, 0xc4, 0xfc}, {0xbc, 0xe0, 0xfc}, {0x10, 0x40, 0x60}, {0x18, 0x50, 0x6c}, 
/* 156 */ {0x28, 0x60, 0x78}, {0x34, 0x70, 0x84}, {0x50, 0x8c, 0xa0}, {0x74, 0xac, 0xc0}, 
/* 160 */ {0x9c, 0xcc, 0xdc}, {0xcc, 0xf0, 0xfc}, {0xac, 0x34, 0x34}, {0xd4, 0x34, 0x34}, 
/* 164 */ {0xfc, 0x34, 0x34}, {0xfc, 0x64, 0x58}, {0xfc, 0x90, 0x7c}, {0xfc, 0xb8, 0xa0}, 
/* 168 */ {0xfc, 0xd8, 0xc8}, {0xfc, 0xf4, 0xec}, {0x48, 0x14, 0x70}, {0x5c, 0x2c, 0x8c}, 
/* 172 */ {0x70, 0x44, 0xa8}, {0x8c, 0x64, 0xc4}, {0xa8, 0x88, 0xe0}, {0xcc, 0xb4, 0xfc}, 
/* 176 */ {0xcc, 0xb4, 0xfc}, {0xe8, 0xd0, 0xfc}, {0x3c, 0x00, 0x00}, {0x5c, 0x00, 0x00}, 
/* 180 */ {0x80, 0x00, 0x00}, {0xa0, 0x00, 0x00}, {0xc4, 0x00, 0x00}, {0xe0, 0x00, 0x00}, 
/* 184 */ {0xfc, 0x00, 0x00}, {0xfc, 0x50, 0x00}, {0xfc, 0x6c, 0x00}, {0xfc, 0x88, 0x00}, 
/* 188 */ {0xfc, 0xa4, 0x00}, {0xfc, 0xc0, 0x00}, {0xfc, 0xdc, 0x00}, {0xfc, 0xfc, 0x00}, 
/* 192 */ {0xcc, 0x88, 0x08}, {0xe4, 0x90, 0x04}, {0xfc, 0x9c, 0x00}, {0xfc, 0xb0, 0x30}, 
/* 196 */ {0xfc, 0xc4, 0x64}, {0xfc, 0xd8, 0x98}, {0x08, 0x18, 0x58}, {0x0c, 0x24, 0x68}, 
/* 200 */ {0x14, 0x34, 0x7c}, {0x1c, 0x44, 0x8c}, {0x28, 0x5c, 0xa4}, {0x38, 0x78, 0xbc}, 
/* 204 */ {0x48, 0x98, 0xd8}, {0x64, 0xac, 0xe0}, {0x5c, 0x9c, 0x34}, {0x6c, 0xb0, 0x40}, 
/* 208 */ {0x7c, 0xc8, 0x4c}, {0x90, 0xe0, 0x5c}, {0xe0, 0xf4, 0xfc}, {0xcc, 0xf0, 0xfc}, 
/* 212 */ {0xb4, 0xdc, 0xec}, {0x84, 0xbc, 0xd8}, {0x58, 0x98, 0xac}, {0x10, 0x10, 0x10}, 
/* 216 */ {0x20, 0x20, 0x20}, {0x08, 0x5c, 0x68}, {0x10, 0x64, 0x70}, {0x18, 0x6c, 0x78}, 
/* 220 */ {0x20, 0x74, 0x80}, {0x2c, 0x7c, 0x8c}, {0x5c, 0xa4, 0xb8}, {0x74, 0xb4, 0xc4}, 
/* 224 */ {0x94, 0xc8, 0xd8}, {0xb4, 0xdc, 0xe8}, {0xd8, 0xf4, 0xfc}, {0x00, 0x00, 0x00}, 
/* 228 */ {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, 
/* 232 */ {0xfc, 0x3c, 0x00}, {0xfc, 0x50, 0x00}, {0xfc, 0x68, 0x00}, {0xfc, 0x80, 0x00}, 
/* 236 */ {0xfc, 0x94, 0x00}, {0xfc, 0xac, 0x00}, {0xfc, 0xc4, 0x00}, {0xfc, 0x00, 0x00}, 
/* 240 */ {0xfc, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, 
/* 244 */ {0xfc, 0xe4, 0x00}, {0x94, 0x94, 0x94}, {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, 
/* 248 */ {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, 
/* 252 */ {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, {0xd4, 0x00, 0xd4}, {0xfc, 0xfc, 0xfc}
};

// indexes of company colors in the palette
int company_color_idx[] = {202, 100, 46, 66, 183, 158, 206, 92, 150, 118, 132, 140, 195, 36, 40, 12};

int ottd_company_color(int c)
{
    if (c < 0 || c > 15) return 0;
    return company_color_idx[c];
}

uint8_t ottd_tile_color(const ottd_t *game, const ottd_tile_t *tile)
{
    if (tile == NULL || game == NULL) return 0;
    uint8_t owner;
    switch(tile->type) {
    case MP_CLEAR:          ///< A tile without any structures, i.e. grass, rocks, farm fields etc.
    case MP_TREES:          ///< Tile got trees
        return SM_COLOUR_NOT_OWNED;
    case MP_RAILWAY:        ///< A railway
    case MP_STATION:        ///< A tile of a station
    case MP_ROAD:           ///< A tile with road (or tram tracks) : tracks(tracks) : tracks(tracks)
    case MP_TUNNELBRIDGE:   ///< Tunnel entry/exit and bridge heads
        // owner color
        owner = (tile->type != MP_ROAD)?tile->owner&0x1F:tile->owner;
        if (owner < OWNER_TOWN && game->company[owner].active) {
            // owned by a company
            return ottd_company_color(game->company[owner].color);
        } else if (owner == OWNER_TOWN) {
            // owned by a town
            return SM_COLOUR_TOWN;
        }
        // not owned?
        return SM_COLOUR_ROAD;
    case MP_HOUSE:          ///< A house by a town
        return SM_COLOUR_TOWN;
    case MP_WATER:          ///< Water tile
        return SM_COLOUR_WATER;
    case MP_VOID:           ///< Invisible tiles at the SW and SE border
        return SM_COLOUR_BLACK;
    case MP_INDUSTRY:       ///< Part of an industry
        return SM_COLOUR_INDUSTRY;
    case MP_OBJECT:         ///< Contains objects such as transmitters and owned land
        owner = tile->owner&0x1F;
        if (owner < OWNER_TOWN && game->company[owner].active) {
            // owned by a company
            return ottd_company_color(game->company[owner].color);
        } else if (owner == OWNER_TOWN) {
            // owned by a town
            return SM_COLOUR_TOWN;
        }
        // default object
        return SM_COLOUR_OBJECT;
    }
	return SM_COLOUR_BLACK;
}

#ifdef HAVE_LIBPNG
int ottd_write_png(const ottd_t *game, const char *png_path, int mode)
{
    FILE *fp = NULL;
    png_structp png = NULL;
    png_infop info = NULL;
    int width, height;
    switch(mode) {
        case OTTD_MAP_ISO:
            width = (game->mapSize.x + game->mapSize.y);
            height = (game->mapSize.x + game->mapSize.y)/2;
            break;
        case OTTD_MAP_NE:
            width = game->mapSize.y-2;
            height = game->mapSize.x-2;
            break;
        case OTTD_MAP_NW:
        default:
            mode = OTTD_MAP_NW;
            width = game->mapSize.x-2;
            height = game->mapSize.y-2;
    }
    
    // initialise write thingy
    png = png_create_write_struct(PNG_LIBPNG_VER_STRING, NULL, NULL, NULL);
    if (png == NULL) goto fail;
    
    // initialise info thingy
    info = png_create_info_struct(png);
    if (info == NULL) goto fail;
    
    // exception handling thingy
    if (setjmp(png_jmpbuf(png))) goto fail;
    
    // open file
    fp = fopen(png_path, "wb");
    if (fp == NULL) return -1;
    png_init_io(png, fp);
    
    // header
    png_set_IHDR(png, info, width, height, 8, PNG_COLOR_TYPE_PALETTE, PNG_INTERLACE_NONE, PNG_COMPRESSION_TYPE_BASE, PNG_FILTER_TYPE_BASE);
    png_set_PLTE(png, info, ottd_color, 256);
    png_write_info(png, info);
    
    // image data
    png_bytep row = malloc(width);
    for(int py=0; py < height; py++) {
        for(int px=0; px < width; px++) {
            ottd_tile_t *tile = &game->tile[py+1][width-px]; // default OTTD_MAP_NW
            if (mode == OTTD_MAP_ISO) {
                int jpx = width-px-game->mapSize.y;
                int ry = (py) - (jpx/2);
                int rx = (py) + (jpx/2);
                if (rx < 0 || ry < 0 || rx >= game->mapSize.x || ry >= game->mapSize.y) {
                    tile = NULL;
                } else {
                    tile = &game->tile[ry][rx];
                }
            } else if (mode == OTTD_MAP_NE) {
                tile = &game->tile[px+1][py+1];
            }
            row[px] = ottd_tile_color(game, tile);
        }
        png_write_row(png, row);
    }
    free(row);
    
    // this is the end
    png_write_end(png, NULL);
    
    return 0;
fail:
    if (fp) fclose(fp);
    if (info) png_free_data(png, info, PNG_FREE_ALL, -1);
    if (png) png_destroy_write_struct(&png, NULL);
    return -1;
}
#endif